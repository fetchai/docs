# Query communication between Agents

This documentation outlines the steps to set up and enable communication between two agents, Agent1 and Agent2, using the uAgents framework. Agent1 sends a query to Agent2, and Agent2 processes this query and responds. Both agents use a simple request-response model for communication.

## Guide

- [How to use on_query decorator ‚ÜóÔ∏è](../guides/agents/on-query)

## Supporting documentation

- [Creating an agent ‚ÜóÔ∏è](/guides/agents/create-a-uagent)
- [Communicating with other agents üì±ü§ñüíª ‚ÜóÔ∏è](/guides/agents/communicating-with-other-agents)
- [Register in Almanac ‚ÜóÔ∏è](/guides/agents/register-in-almanac)
- [Almanac Contract ‚ÜóÔ∏è](/references/contracts/uagents-almanac/almanac-overview)
- [Protocols ‚ÜóÔ∏è](/references/uagents/uagents-protocols/agent-protocols)

## Agent Scripts

### Agent1 Script

This agent queries another agent. Asking the address for another agent which is stored in it's storage.

```py copy filename = agent1.py
from uagents import Agent, Context, Model
from uagents.query import query
import json

class Request(Model):
    query: str
class Response(Model):
    response: str

Agent1 = Agent(
    name="Agent1",
    seed="Agent1 Seed Phrase",
    port=8001,
    endpoint="http://localhost:8001/submit",
)

AGENT2_ADDRESS = 'Agent 2 address here where query is to be sent.'

@Agent1.on_event("startup")
async def startup(ctx: Context):
    ctx.logger.info(f"Starting up {Agent1.name}")
    ctx.logger.info(f"With address: {Agent1.address}")
    ctx.logger.info(f"And wallet address: {Agent1.wallet.address()}")

    # Create an instance of QueryRequest with your message
    query_request = Request(query="Agent Address")
    
    # Pass the query_request instance instead of a string
    response = await query(destination=AGENT2_ADDRESS, message=query_request, timeout=15.0)
    print(response)
    data = json.loads(response.decode_payload())
    data = data['response']
    ctx.logger.info(f'Response for query is {data}')

if __name__ == "__main__":
    Agent1.run()
```

### Agent 2 Script

This script handles the query request from `Agent1` and responds the value of agent's address in its storage.

```py copy filename = agent2.py
from uagents import Agent, Context, Model
from uagents.setup import fund_agent_if_low
 
class Request(Model):
    query: str
class Response(Model):
    response: str
 
Agent2 = Agent(
    name="Agent2",
    port=8000,
    seed="Agent2 secret phrase",
    endpoint=["http://127.0.0.1:8000/submit"],
)
 
fund_agent_if_low(Agent2.wallet.address())
 
@Agent2.on_event('startup')
async def agent_details(ctx: Context):
    ctx.logger.info(f'Agent2 Address is {Agent2.address}')
    ctx.storage.set("Agent Address", Agent2.address)
 
@Agent2.on_query(model=Request, replies={Response})
async def query_handler(ctx: Context, sender: str, msg: Request):
    ctx.logger.info("Query received")
    try:
        response = ctx.storage.get(msg.query)
        await ctx.send(sender, Response(response=response))
    except Exception:
        await ctx.send(sender, Response(response="No Response Recieved"))
 
if __name__ == "__main__":
    Agent2.run()
```

- Run both the script `agent1.py` and `agent2.py` on your terminal.

## Expected Output

- Agent1.py 

```
INFO:     [Agent1]: Almanac registration is up to date!
INFO:     [Agent1]: Starting up Agent1
INFO:     [Agent1]: With address: agent1qtxuw74yjqwa9mew2eru8afulhl9dj5w9avvftceudxcuzrv2tvhjh8grsp
INFO:     [Agent1]: And wallet address: fetch1w73u6uj996nt5wela5w47hy6z69cd6rwp08js2
version=1 sender='agent1qfa3sn39krax6pepnexfv3tuha3hqdkfxz0tnm6t6wadmc9ets3f2hj5a8z' target='' session=UUID('74de7d54-38c7-44f1-8ead-c2294a948b5e') schema_digest='model:c386105a5e52860d5885cb07aeeb6258f33fe31b9adbaae0ac4301c8a9837ba5' protocol_digest=None payload='eyJyZXNwb25zZSI6ICJhZ2VudDFxZmEzc24zOWtyYXg2cGVwbmV4ZnYzdHVoYTNocWRrZnh6MHRubTZ0NndhZG1jOWV0czNmMmhqNWE4eiJ9' expires=None nonce=None signature=None
INFO:     [Agent1]: Response for query is agent1qfa3sn39krax6pepnexfv3tuha3hqdkfxz0tnm6t6wadmc9ets3f2hj5a8z
INFO:     [Agent1]: Starting server on http://0.0.0.0:8001 (Press CTRL+C to quit)
```

- Agent2.py 

```
INFO:     [Agent2]: Almanac registration is up to date!
INFO:     [Agent2]: Agent2 Address is agent1qfa3sn39krax6pepnexfv3tuha3hqdkfxz0tnm6t6wadmc9ets3f2hj5a8z
INFO:     [Agent2]: Starting server on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     [Agent2]: Query received
```