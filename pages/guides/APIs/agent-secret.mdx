# Adding Secret to agent using Agentverse API

## Introduction

This example provides details on how to use the hosting API to add a secret to an agent. Secrets are added to an agent to ensure they remain hidden from end users and to enhance security.

## Prerequisites

- Before you begin, ensure you have the following:  
    1. Python version greater than 3.9 and less than 3.11.
    2. The requests library installed. You can install it using `pip install requests`.
    3. Agentverse Credentials
    4. Fauna Token script for getting fauna tokens and refresh tokens.

    Steps to setup `faunatoken.py` script.

        1. Open terminal on your computer and use `mkdir agents` to creat directory.
        2. Create a python script file named `chatapi.py` and include below script in that file. For more information on file please visit [Fauna Token ↗️](../guides/apis/fauna_token)

    ```py copy filename=faunatoken.py
    import threading
    import time
    import requests
    import urllib.parse
    from http.server import BaseHTTPRequestHandler, HTTPServer

    # Constants for the OAuth flow and API interaction.
    FAUNA_URL = 'https://accounts.fetch.ai'
    SCOPE = 'av'
    CLIENT_ID = 'agentverse'
    TOKEN_URL = f'{FAUNA_URL}/v1/tokens'
    REDIRECT_URI = 'http://localhost:8555'
    access_code = None

    class OAuthServer(BaseHTTPRequestHandler):
        def log_message(self, format, *args):
            # Suppress default logging for clarity.
            return

        def do_GET(self):
            global access_code
            parsed = urllib.parse.urlparse(self.path)
            params = urllib.parse.parse_qs(parsed.query)
            if 'code' in params:
                access_code = params['code'][0]
                with open('access_code.txt', 'w') as f:
                    f.write(access_code)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b'Authentication successful, you may now close this tab.')
            else:
                self.send_response(400)
                self.end_headers()
                self.wfile.write(b'Missing authorization code.')

    def start_server():
        # Starts the HTTP server to handle OAuth redirects.
        server = HTTPServer(('127.0.0.1', 8555), OAuthServer)
        threading.Thread(target=server.serve_forever).start()
        return server

    def get_tokens(auth_code):
        # Exchanges authorization code for access and refresh tokens.
        response = requests.post(
            TOKEN_URL,
            json={
                'grant_type': 'authorization_code',
                'code': auth_code,
                'client_id': CLIENT_ID,
                'redirect_uri': REDIRECT_URI,
                'scope': SCOPE,
            }
        )
        response.raise_for_status()
        fauna_token = response.json()['access_token']
        refresh_token = response.json()['refresh_token']
        return fauna_token, refresh_token

    def refresh_tokens(refresh_token):
        # Uses the refresh token to obtain a new access token and refresh token.
        response = requests.post(
            TOKEN_URL,
            json={
                'grant_type': 'refresh_token',
                'refresh_token': refresh_token,
                'client_id': CLIENT_ID,
                'scope': SCOPE,
            }
        )
        response.raise_for_status()
        fauna_token = response.json()['access_token']
        refresh_token = response.json()['refresh_token']
        return fauna_token, refresh_token

    def get_auth_url():
        # Generates URL for initiating OAuth authorization.
        return f'{FAUNA_URL}/login/?{urllib.parse.urlencode({"redirect_uri": REDIRECT_URI, "client_id": CLIENT_ID, "response_type": "code", "scope": SCOPE})}'

    def shutdown_server(server):
        # Shuts down the OAuth redirect HTTP server.
        server.shutdown()
    ```

## Script to add secret to agent

``` py copy filename=agent-secret.py
    # Importing libraries
    import requests
    from faunatoken import start_server, shutdown_server, get_auth_url, get_tokens 


    # Starting the authentication and session initiation process
    server = start_server()
    print("Please visit the following URL to authenticate:")
    print(get_auth_url())
    input("Press Enter after authentication...")
    filename = 'access_code.txt'

    with open(filename, 'r') as file:
        access_code = file.read().strip()

    if access_code:
        tokens = get_tokens(access_code)
        fauna_token = tokens[0]
        refreshed_token = tokens[1]
        token = f'Bearer {fauna_token}'
    else:
        print("Authentication failed. Please ensure you have entered the correct access code.")
        exit()

    # Take name of agent and secret details from user
    address = input('Please enter address of agent to which you want to add address')
    name = input("Please enter name for your secret")
    secret = input("Please enter value for your secret")

    # Create Payload for post request
    data = {
    'address': address,
    'name': name,
    'secret': secret
    }

    # Post request to add secret to agent
    response_agent = requests.post("https://agentverse.ai/v1/hosting/secrets", json=data, headers={
        "Authorization": token
    })


    # Check if the response code is 200
    if response_agent.status_code == 200:
        print("Secret added successfully.")
    else:
        print(f"Failed to add secret. Status code: {response_agent.status_code}")

    # Shutting down server once secret is added.
    shutdown_server(server)
```


## Steps to add secret to agent using API

    - Navigate to directory where `agent-secret` and `faunatoken` scripts are located using terminal.
    - Run `agent-secret.py` file using `python agent-secret.py` file.
    - Provide agent's address, secret name and secret value.

### Expected Output

    - Authenticate to fetch token using URL and give details on terminal to create agent.

![](../../src/images/APIs/chatAPI1.png)

    - Provide details and response on baisi of secret added or not to the agent in agentverse.

![](../../src/images/APIs/chatsecret1.png)

![](../../src/images/APIs/chatsecret2.png)