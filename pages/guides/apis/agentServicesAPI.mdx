import { Callout } from 'nextra/components'

# uAgent and Service Creation using APIs

## Introduction

This example gives details on how to create uagents and respective services in Agentverse using APIs. we will demonstrate python script that 
interacts with Agentverse and help us creating agents and services.

## Prerequisites

- Before you begin, ensure you have the following:  
    1. Python version greater than 3.9 and less than 3.11.
    2. The requests library installed. You can install it using `pip install requests` .
    3. An API token (fauna) from Agentverse, which will be used for authentication.  
<br></br>
- Steps to get API Token:
    1. Login to [Agentverse ↗️](https://agentverse.ai/).
    2. Right click on chrome browser and select Inspect
    3. Go to the application tab and look for cookies.
    4. Select Agenverse.ai and select fauna cookie.
    5. Copy the fauna’s value and this is your token key.

## Steps to create agent and respective service

    - Open terminal and create a directory `agents` using `mkdir agents`.
    - Create a python file `agent.py` in this directory and include the following sample script in the python file.

    ```python copy filename = 'agent.py'
    import requests
    import json
    from ai_engine import UAgentResponse, UAgentResponseType

    class Coordinates(Model):
        location : str

    location_protocol = Protocol("Location Coordinates")

    async def location_coordinates(latitude, longitude):
        url = "https://geocoding-by-api-ninjas.p.rapidapi.com/v1/reversegeocoding"
        querystring = {"lat": latitude,"lon":longitude}

        headers = {
            "X-RapidAPI-Key": "YOUR_API_KEY",
            "X-RapidAPI-Host": "geocoding-by-api-ninjas.p.rapidapi.com"
        }

        response = requests.get(url, headers=headers, params=querystring)

        data = response.json()[0]['name']

        return data


    @location_protocol.on_message(model=Coordinates, replies = UAgentResponse)
    async def location_coordinates_calculator(ctx: Context, sender: str, msg: Coordinates):
        ctx.logger.info(msg.location)
        latitude, longitude = map(str.strip, msg.location.split(','))
        city = location_coordinates(latitude, longitude)
        ctx.logger.info(city)
        message = city
        await ctx.send(sender, UAgentResponse(message = message, type = UAgentResponseType.FINAL))

    agent.include(location_protocol)
    ```


### Script breakdown
    - Create a python file with name `agent_create.py`.
    - Importing required libraries and defining token

    ``` python
    # Importing Required libraries
    import time
    import requests

    # Define tokebn
    token = 'bearer <YOUR_FAUNA_TOKEN_HERE>'
    ```

    - Taking agent Name from user and storing agent address

    ```python
    # Taking agent name input from user
    name = input('Please give name of your agent?')

    # Creating payload for agent creation request
    agent_creation_data = {
        "name": name
    }

    # Storing response of agent creation request
    response_agent = requests.post("https://agentverse.ai/v1/hosting/agents", json=agent_creation_data, headers={
        "Authorization": token
    })
    response_agent = response_agent.json()

    # Storing and printing agent address for further use
    address = response_agent['address']
    print(f'Agent Address : {address}')
    ```

    - Taking code from `agent.py` file and storing it as created agent script.

    ```python
    # Reading code from agent.py file and storing it in code variable
    with open('agent.py', 'r') as file:
        code = file.read()

    # Creating payload for updating agent code
    agent_code_data = {
        "code": code
    }

    # Updating code for the created agent using Hosting API
    respone_code_update = requests.put(f"https://agentverse.ai/v1/hosting/agents/{address}/code", json=agent_code_data, headers={
        "Authorization": token
    })

    # Starting the agent once the code is updated.
    requests.post(f"https://agentverse.ai/v1/hosting/agents/{address}/start", headers={
        "Authorization": token
    })

    # Adding pause to script before requesting protocol digest.
    time.sleep(10)
    ```

    - Requesting protocol digest for the created agent

    ```python
    # Requesting and saving response for protocol digest of the updated agent using almanac API
    response_protcol = requests.get(f"https://agentverse.ai/v1/almanac/agents/{address}", headers={
        "Authorization": token
    })

    # Stroing protocol digest from response recieved.
    protocol_digest = response_protcol.json()['protocols'][1]
    print(f'Protocol Digest : {protocol_digest}')

    # Adding pause to script before requesting model digest.
    time.sleep(10)
    ```

    - Request model digest and name using almanac API

    ```python
    # Requesting and saving response for model digest and name of the updated agent using almanac API
    response_model = requests.get(f"https://agentverse.ai/v1/almanac/manifests/protocols/{protocol_digest}", headers={
        "Authorization": token
    })

    # Saving model details to model variable
    model = response_model.json()['models']

    time.sleep(10)
    ```
    
    - Saving all the details required for creating service and creating service on basis of details recieved

    ```python
    # Taking inputs from user for details required to create a service
    name_service = input('Please give service name')
    description = input('Please enter service description')
    field_name = input('Please enter field name')
    field_description = input('Please enter field description')
    tasktype = input('Please tell task or subtask')

    # Logging details provided by user
   print(f'Service name: {name_service} \nService Description: {description} \nField Name: {field_name}\nField Description: {field_description}\nTask Type: {tasktype}')

    # Storing model diges and name to be used for service creation
    model_digest = response_model.json()['interactions'][0]['request'].replace('model:', '')
    print(f'Model Digest : {model_digest}')
    model_name = model[0]['schema']['title']
    print(f'Model Name : {model_name}')

    # Creating payload for service creation
    data = {
        "agent": address,
        "name": name_service,
        "description": description,
        "protocolDigest": protocol_digest,
        "modelDigest": model_digest,
        "modelName": model_name,
        "fields": [
            {
                "name":field_name,
                "required": True,
                "field_type": "string",
                "description": field_description
            }
        ],
        "taskType": tasktype
    }

    # Requesting AI Engine services API to create a service with created payload and storing the response.
    response_service = requests.post("https://agentverse.ai/v1beta1/services", json=data, headers={
        "Authorization": token
    })

    # Storing name of serive and printing it to check if service was created successfully
    name = response_service.json()['name']
    print(f'Service Created with name: {name}')
    ```

### Whole Script

```python copy filename = 'agent_create.py'
# Importing Required libraries
import time
import requests

# Define token
token = 'bearer <YOUR_FAUNA_TOKEN_HERE>'

# Taking agent name input from user
name = input('Please give name of your agent? ')

# Creating payload for agent creation request
agent_creation_data = {
    "name": name
}

# Storing response of agent creation request
response_agent = requests.post("https://agentverse.ai/v1/hosting/agents", json=agent_creation_data, headers={
    "Authorization": token
})
response_agent = response_agent.json()

# Storing and printing agent address for further use
address = response_agent['address']
print(f'Agent Address: {address}')

# Reading code from agent.py file and storing it in code variable
with open('agent.py', 'r') as file:
    code = file.read()

# Creating payload for updating agent code
agent_code_data = {
    "code": code
}

# Updating code for the created agent using Hosting API
respone_code_update = requests.put(f"https://agentverse.ai/v1/hosting/agents/{address}/code", json=agent_code_data, headers={
    "Authorization": token
})

# Starting the agent once the code is updated.
requests.post(f"https://agentverse.ai/v1/hosting/agents/{address}/start", headers={
    "Authorization": token
})

# Adding pause to script before requesting protocol digest.
time.sleep(10)

# Requesting and saving response for protocol digest of the updated agent using almanac API
response_protcol = requests.get(f"https://agentverse.ai/v1/almanac/agents/{address}", headers={
    "Authorization": token
})

# Stroing protocol digest from response recieved.
protocol_digest = response_protcol.json()['protocols'][1]
print(f'Protocol Digest: {protocol_digest}')

# Adding pause to script before requesting model digest.
time.sleep(10)

# Requesting and saving response for model digest and name of the updated agent using almanac API
response_model = requests.get(f"https://agentverse.ai/v1/almanac/manifests/protocols/{protocol_digest}", headers={
    "Authorization": token
})

# Saving model details to model variable
model = response_model.json()['models']

time.sleep(10)

# Taking inputs from user for details required to create a service
name_service = input('Please give service name')
description = input('Please enter service description')
field_name = input('Please enter field name')
field_description = input('Please enter field description')
tasktype = input('Please tell task or subtask')

# Logging details provided by user
print(f'Service name: {name_service} \nService Description: {description} \nField Name: {field_name}\nField Description: {field_description}\nTask Type: {tasktype}')

# Storing model diges and name to be used for service creation
model_digest = response_model.json()['interactions'][0]['request'].replace('model:', '')
print(f'Model Digest : {model_digest}')
model_name = model[0]['schema']['title']
print(f'Model Name : {model_name}')

# Creating payload for service creation
data = {
    "agent": address,
    "name": name_service,
    "description": description,
    "protocolDigest": protocol_digest,
    "modelDigest": model_digest,
    "modelName": model_name,
    "fields": [
        {
            "name":field_name,
            "required": True,
            "field_type": "string",
            "description": field_description
        }
    ],
    "taskType": tasktype
}

# Requesting AI Engine services API to create a service with created payload and storing the response.
response_service = requests.post("https://agentverse.ai/v1beta1/services", json=data, headers={
    "Authorization": token
})

# Storing name of serive and printing it to check if service was created successfully
name = response_service.json()['name']
print(f'Service Created with name : {name}')
```
    

## Steps to run the script

- Open terminal and go to directory `agents` created above.
- Make sure agent.py and pipeline.py are in this directory.
- Run command `python agent_create.py` and enter the required details.


<Callout type="warning" emoji="⚠️">
    Make sure to update script with your fauna token to access the API calls.
</Callout>

- Expected Output

![](../../../src/images/APIs/API_agent.png)

- Agent created on Agentverse

![](../../../src/images/APIs/API_agent2.png)

- Service created on Agentverse

![](../../../src/images/APIs/API_Service.png)